workflows:
  full_android_build:
    name: "AI-Driven Android APK Builder"
    environment:
      node: 20
      java: 21
      android: 33
      vars:
        PACKAGE_NAME: "app.accs.tofo"

    scripts:
      - |
        echo "ğŸ¤– Verifying Node, Java, Android SDK, and Gradle CLI..."
        node -v || (echo "âŒ Node not available!" && exit 1)
        npm -v || (echo "âŒ npm not installed!" && exit 1)
        java -version || (echo "âŒ Java missing!" && exit 1)
        sdkmanager --list || echo "âš ï¸ SDK manager not available (might not be needed)"
        gradle -v || echo "ğŸ”§ Gradle CLI not installed globally. Wrapper will be used."

      - |
        echo "ğŸ“¦ Installing npm dependencies..."
        npm install || npm ci || (echo "âŒ npm install failed. Retrying with clean cache..." && rm -rf node_modules package-lock.json && npm install)

      - |
        echo "ğŸ”§ Building frontend with Vite..."
        npm run build || (echo "âŒ Vite build failed. Rechecking scripts..." && npm run build)

      - |
        echo "ğŸ“ Verifying Android platform..."
        if [ ! -d "android" ] || [ ! -f "capacitor.config.ts" ] && [ ! -f "capacitor.config.json" ]; then
          echo "ğŸ› ï¸ Adding missing Android platform..."
          npx cap add android || (echo "âŒ Capacitor add android failed" && exit 1)
        fi

      - |
        echo "ğŸ”„ Syncing Capacitor..."
        npx cap sync android || (echo "âŒ cap sync failed. Trying force sync..." && npx cap update android && npx cap sync)

      - |
        echo "ğŸ§¼ Fixing JVM and environment variables..."
        unset DEFAULT_JVM_OPTS
        export JAVA_TOOL_OPTIONS=""
        export GRADLE_OPTS="-Dorg.gradle.jvmargs=-Xmx4096m"

      - |
        echo "ğŸ” Validating android/gradle wrapper..."
        if [ ! -f "android/gradlew" ]; then
          echo "âš ï¸ gradlew missing â€” generating Gradle wrapper..."
          cd android
          gradle wrapper --gradle-version 8.7 || (echo "âŒ gradle wrapper creation failed!" && exit 1)
          cd ..
        fi

      - |
        echo "ğŸ” Fixing gradlew permissions and line endings..."
        chmod +x android/gradlew
        dos2unix android/gradlew || sed -i 's/\r$//' android/gradlew # cross-platform fix

      - |
        echo "ğŸ§¾ Ensuring gradle.properties is sane..."
        if [ ! -f "android/gradle.properties" ]; then
          echo "Creating gradle.properties..."
          echo "org.gradle.jvmargs=-Xmx4g" > android/gradle.properties
        fi

      - |
        echo "ğŸ§½ Cleaning previous builds..."
        cd android
        ./gradlew clean --warning-mode=all || (echo "âŒ Clean failed. Forcing again..." && ./gradlew clean)

      - |
        echo "ğŸ“¦ Building APK (debug mode)..."
        ./gradlew assembleDebug --stacktrace || (
          echo "âš ï¸ Initial build failed â€” retrying with --no-daemon and debug logs..."
          ./gradlew assembleDebug --no-daemon --info --stacktrace || (
            echo "ğŸ›  Final fallback attempt with Gradle refresh..."
            ./gradlew build --refresh-dependencies || exit 1
          )
        )

    artifacts:
      - android/app/build/outputs/**/*.apk

    publishing:
      email:
        recipients:
          - your@email.com
        notify:
          success: true
          failure: true
